{% extends "layout.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Projektek</h2>
    <a href="{{ url_for('new_project') }}" class="btn btn-primary">➕ Új Projekt Hozzáadása</a>
</div>
<div class="table-responsive">
    <table class="table table-striped table-hover" id="project-table">
        <thead>
            <tr>
                <th>Projekt Neve</th>
                <th>Ütemezés</th>
                <th>Utolsó mentés</th>
                <th>Állapot</th>
                <th class="text-end">Műveletek</th>
            </tr>
        </thead>
        <tbody>
            {% for project in projects %}
            <tr id="project-row-{{ project.id }}">
                <td class="fw-bold">{{ project.name }}</td>
                <td><span class="badge bg-secondary">{{ project.backup_schedule|capitalize }}</span></td>
                <td>{{ project.last_backup_time }}</td>
                <td class="status-cell">
                    <small class="text-muted">{{ project.last_backup_status }}</small>
                </td>
                <td class="text-end action-cell">
                    <a href="{{ url_for('list_backups', id=project.id) }}" class="btn btn-info btn-sm">Mentések</a>
                    <button class="btn btn-success btn-sm backup-button"
                        data-url="{{ url_for('backup_project', id=project.id) }}">
                        Mentés most
                    </button>
                    <a href="{{ url_for('edit_project', id=project.id) }}"
                        class="btn btn-secondary btn-sm">Szerkesztés</a>
                    <form action="{{ url_for('delete_project', id=project.id) }}" method="POST" class="d-inline"
                        onsubmit="return confirm('Biztosan törlöd a(z) {{ project.name }} projektet?');">
                        <button type="submit" class="btn btn-danger btn-sm">Törlés</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" class="text-center py-4">Még nincsenek projektek. Adj hozzá egyet a gombbal!</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const backupButtons = document.querySelectorAll('.backup-button');

        backupButtons.forEach(button => {
            button.addEventListener('click', function (event) {
                event.preventDefault();
                const backupUrl = this.dataset.url;
                const row = this.closest('tr');
                const statusCell = row.querySelector('.status-cell');
                const actionCell = row.querySelector('.action-cell');

                // Az összes gomb letiltása
                document.querySelectorAll('.backup-button').forEach(btn => btn.disabled = true);
                statusCell.innerHTML = `<div class="spinner-border spinner-border-sm text-primary" role="status"></div> <small>Indítás...</small>`;

                // 1. A mentés elindítása
                fetch(backupUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'started') {
                            // 2. A poller elindítása
                            pollStatus(data.project_name, data.timestamp, statusCell);
                        } else {
                            statusCell.innerHTML = `<small class="text-danger">Hiba az indításkor.</small>`;
                        }
                    })
                    .catch(error => {
                        statusCell.innerHTML = `<small class="text-danger">Hiba: ${error}</small>`;
                        // Gombok újraengedélyezése hiba esetén
                        document.querySelectorAll('.backup-button').forEach(btn => btn.disabled = false);
                    });
            });
        });

        function pollStatus(projectName, timestamp, statusCell) {
            const statusUrl = `/status/${projectName}/${timestamp}`;

            const intervalId = setInterval(() => {
                fetch(statusUrl)
                    .then(response => response.json())
                    .then(data => {
                        statusCell.innerHTML = `<div class="spinner-border spinner-border-sm text-primary" role="status"></div> <small>${data.status}</small>`;

                        // Ha kész vagy hiba van, leállítjuk a poller-t
                        if (data.status.includes('KÉSZ!') || data.status.includes('HIBA:')) {
                            clearInterval(intervalId);
                            // Pár másodperc múlva frissítjük az oldalt, hogy az új adatok megjelenjenek
                            setTimeout(() => window.location.reload(), 2000);
                        }
                    })
                    .catch(error => {
                        statusCell.innerHTML = `<small class="text-danger">Státusz lekérdezési hiba.</small>`;
                        clearInterval(intervalId);
                        setTimeout(() => window.location.reload(), 2000);
                    });
            }, 2000); // 2 másodpercenként kérdezzük le az állapotot
        }
    });
</script>
{% endblock %}